{% extends "base.html" %}

{% block title %}{{ _('Covenant Tracking') }} - {{ _('SME Debt Tool') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-clipboard-check me-2"></i>{{ _('Debt Covenant Tracking') }}
            </h1>
            <p class="lead text-muted">{{ _('Track and monitor debt covenants to maintain compliance') }}</p>
        </div>

        <!-- Covenant Form -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>{{ _('Add Covenant') }}
                </h5>
            </div>
            <div class="card-body">
                <form id="covenantForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="covenantName" class="form-label">
                                    <i class="fas fa-tag me-1"></i>{{ _('Covenant Name') }}
                                </label>
                                <input type="text" class="form-control" id="covenantName" name="covenantName" 
                                       placeholder="{{ _('Enter covenant name') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="covenantType" class="form-label">
                                    <i class="fas fa-list me-1"></i>{{ _('Covenant Type') }}
                                </label>
                                <select class="form-select" id="covenantType" name="covenantType" required>
                                    <option value="">{{ _('Select type') }}</option>
                                    <option value="financial">{{ _('Financial Ratio') }}</option>
                                    <option value="operational">{{ _('Operational') }}</option>
                                    <option value="reporting">{{ _('Reporting') }}</option>
                                    <option value="other">{{ _('Other') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="threshold" class="form-label">
                                    <i class="fas fa-chart-line me-1"></i>{{ _('Threshold Value') }}
                                </label>
                                <input type="number" step="0.01" class="form-control" id="threshold" name="threshold" 
                                       placeholder="{{ _('Enter threshold') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="currentValue" class="form-label">
                                    <i class="fas fa-calculator me-1"></i>{{ _('Current Value') }}
                                </label>
                                <input type="number" step="0.01" class="form-control" id="currentValue" name="currentValue" 
                                       placeholder="{{ _('Enter current value') }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            <i class="fas fa-align-left me-1"></i>{{ _('Description') }}
                        </label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="{{ _('Enter covenant description') }}"></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-2"></i>{{ _('Add Covenant') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Covenant List -->
        <div class="card shadow mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>{{ _('Covenant Dashboard') }}
                </h5>
            </div>
            <div class="card-body">
                <div id="covenantList">
                    <p class="text-muted text-center">{{ _('No covenants added yet. Add your first covenant above.') }}</p>
                </div>
            </div>
        </div>

        <!-- Information Panel -->
        <div class="card shadow mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>{{ _('About Debt Covenants') }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-clipboard-check text-primary me-1"></i>{{ _('What are Covenants?') }}</h6>
                        <p class="small">{{ _('Debt covenants are agreements between borrowers and lenders that specify certain conditions and restrictions.') }}</p>
                        
                        <h6><i class="fas fa-chart-line text-success me-1"></i>{{ _('Common Types') }}</h6>
                        <ul class="small">
                            <li>{{ _('Debt-to-equity ratio limits') }}</li>
                            <li>{{ _('Interest coverage ratios') }}</li>
                            <li>{{ _('Working capital requirements') }}</li>
                            <li>{{ _('Cash flow covenants') }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-1"></i>{{ _('Why Monitor?') }}</h6>
                        <ul class="small">
                            <li>{{ _('Prevents covenant breaches') }}</li>
                            <li>{{ _('Maintains lender relationships') }}</li>
                            <li>{{ _('Avoids penalties') }}</li>
                            <li>{{ _('Ensures compliance') }}</li>
                        </ul>
                        
                        <h6><i class="fas fa-lightbulb text-info me-1"></i>{{ _('Important Note') }}</h6>
                        <p class="small">{{ _('This tool helps track covenants but does not replace professional legal or financial advice.') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let covenants = [];

    document.getElementById('covenantForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const covenant = {
            name: formData.get('covenantName'),
            type: formData.get('covenantType'),
            threshold: parseFloat(formData.get('threshold')),
            currentValue: parseFloat(formData.get('currentValue')),
            description: formData.get('description')
        };
        
        covenants.push(covenant);
        updateCovenantList();
        
        // Clear form
        this.reset();
        
        try {
            const response = await fetch('/api/covenant-tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(covenant)
            });
            
            const result = await response.json();
            console.log('Covenant saved:', result);
        } catch (error) {
            console.error('Error:', error);
            alert('{{ _("An error occurred. Please try again.") }}');
        }
    });
    
    function updateCovenantList() {
        const covenantList = document.getElementById('covenantList');
        
        if (covenants.length === 0) {
            covenantList.innerHTML = '<p class="text-muted text-center">{{ _("No covenants added yet. Add your first covenant above.") }}</p>';
            return;
        }
        
        covenantList.innerHTML = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>{{ _("Covenant") }}</th><th>{{ _("Type") }}</th><th>{{ _("Threshold") }}</th><th>{{ _("Current") }}</th><th>{{ _("Status") }}</th></tr></thead><tbody></tbody></table></div>';
        
        const tbody = covenantList.querySelector('tbody');
        covenants.forEach(covenant => {
            const row = tbody.insertRow();
            const status = covenant.currentValue <= covenant.threshold ? 
                '<span class="badge bg-success">{{ _("Compliant") }}</span>' : 
                '<span class="badge bg-danger">{{ _("Breach") }}</span>';
            
            row.insertCell(0).textContent = covenant.name;
            row.insertCell(1).textContent = covenant.type;
            row.insertCell(2).textContent = covenant.threshold;
            row.insertCell(3).textContent = covenant.currentValue;
            row.insertCell(4).innerHTML = status;
        });
    }
</script>
{% endblock %}