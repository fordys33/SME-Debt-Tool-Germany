{% extends "base.html" %}

{% block head %}
<!-- Chart.js for visual results -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Tooltip library -->
<script src="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>{{ _('Debt Brake Calculator') }}
                </h2>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">{{ _('Calculate the maximum sustainable debt level for your SME based on income and expenses.') }}</p>
                
                <form id="debtBrakeForm">
                    <!-- Progress Indicator -->
                    <div class="progress mb-4" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="formProgress"></div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="revenue" class="form-label">
                                {{ _('Annual Revenue') }} (€)
                                <i class="fas fa-info-circle text-muted ms-1" data-tippy-content="{{ _('Enter your total annual sales revenue before any expenses. For SMEs, this typically ranges from €50K to €10M depending on your industry.') }}"></i>
                            </label>
                            <input type="number" class="form-control" id="revenue" name="revenue" 
                                   placeholder="500000" min="0" step="1000" required
                                   data-tippy-content="{{ _('Example: If your business makes €500,000 in sales per year, enter 500000') }}">
                            <div class="form-text">{{ _('Your total annual revenue') }}</div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <label for="expenses" class="form-label">
                                {{ _('Annual Expenses') }} (€)
                                <i class="fas fa-info-circle text-muted ms-1" data-tippy-content="{{ _('Include all operating costs: salaries, rent, utilities, materials, marketing, etc. Do not include debt payments here.') }}"></i>
                            </label>
                            <input type="number" class="form-control" id="expenses" name="expenses" 
                                   placeholder="400000" min="0" step="1000" required
                                   data-tippy-content="{{ _('Example: If your monthly expenses are €30,000, annual expenses would be €360,000') }}">
                            <div class="form-text">{{ _('Your total annual expenses') }}</div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <label for="existingDebt" class="form-label">
                                {{ _('Existing Debt') }} (€)
                                <i class="fas fa-info-circle text-muted ms-1" data-tippy-content="{{ _('Total outstanding loans, credit lines, and other debt obligations. Include both principal and any accrued interest.') }}"></i>
                            </label>
                            <input type="number" class="form-control" id="existingDebt" name="existingDebt" 
                                   placeholder="100000" min="0" step="1000" required
                                   data-tippy-content="{{ _('Example: If you have €100,000 in bank loans and €50,000 in credit lines, enter 150000') }}">
                            <div class="form-text">{{ _('Current outstanding debt') }}</div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <label for="debtServiceRatio" class="form-label">
                                {{ _('Max Debt Service Ratio') }} (%)
                                <i class="fas fa-info-circle text-muted ms-1" data-tippy-content="{{ _('Maximum percentage of your net income that should go toward debt payments. Lower ratios (25-30%) are safer for SMEs.') }}"></i>
                            </label>
                            <select class="form-select" id="debtServiceRatio" name="debtServiceRatio">
                                <option value="0.25">25% {{ _('(Conservative)') }}</option>
                                <option value="0.30" selected>30% {{ _('(Balanced)') }}</option>
                                <option value="0.35">35% {{ _('(Moderate Risk)') }}</option>
                                <option value="0.40">40% {{ _('(Higher Risk)') }}</option>
                            </select>
                            <div class="form-text">{{ _('Maximum percentage of net income for debt service') }}</div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>{{ _('Reset') }}
                        </button>
                        <button type="button" class="btn btn-primary" onclick="calculateDebtBrake()">
                            <i class="fas fa-calculator me-2"></i>{{ _('Calculate') }}
                        </button>
                    </div>
                </form>
                
                <!-- Results Section -->
                <div id="results" class="mt-4" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{{ _('Results') }}
                        </h4>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-1"></i>{{ _('PDF') }}
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-1"></i>{{ _('Excel') }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Visual Chart -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>{{ _('Debt Analysis Overview') }}
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="debtChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-lg-4">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>{{ _('How It Works') }}
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-3">{{ _('The Debt Brake Calculator helps you determine the maximum sustainable debt level for your business.') }}</p>
                
                <h6>{{ _('Calculation Method:') }}</h6>
                <ol class="small">
                    <li class="mb-2">{{ _('Calculate net income (Revenue - Expenses)') }}</li>
                    <li class="mb-2">{{ _('Determine maximum debt service (Net Income × Ratio)') }}</li>
                    <li class="mb-2">{{ _('Calculate maximum new debt capacity') }}</li>
                    <li class="mb-2">{{ _('Assess current debt-to-income ratio') }}</li>
                </ol>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>{{ _('Tip:') }}</strong> {{ _('A debt service ratio of 30% is generally considered safe for most businesses.') }}
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ _('Important Notes') }}
                </h4>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        {{ _('This is a simplified calculation') }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        {{ _('Consider seasonal variations in income') }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        {{ _('Account for emergency reserves') }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        {{ _('Consult with financial advisors') }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Hidden translations for JavaScript -->
<div id="translations" style="display: none;"
     data-please-fill-in-all-required-fields="{{ _('Please fill in all required fields.') }}"
     data-net-income="{{ _('Net Income') }}"
     data-max-monthly-debt-service="{{ _('Max Monthly Debt Service') }}"
     data-max-new-debt-capacity="{{ _('Max New Debt Capacity') }}"
     data-current-debt-to-income-ratio="{{ _('Current Debt-to-Income Ratio') }}"
     data-sustainable="{{ _('Sustainable') }}"
     data-warning="{{ _('Warning') }}"
     data-sustainable-limits="{{ _('Your current debt level is within sustainable limits.') }}"
     data-exceeds-limits="{{ _('Your current debt level exceeds recommended limits. Consider reducing debt or increasing income.') }}">
</div>

<script>
// Initialize tooltips and form tracking
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    tippy('[data-tippy-content]', {
        theme: 'light',
        placement: 'top',
        delay: [300, 100]
    });
    
    // Initialize form progress tracking
    const form = document.getElementById('debtBrakeForm');
    const inputs = form.querySelectorAll('input[required], select[required]');
    const progressBar = document.getElementById('formProgress');
    
    function updateProgress() {
        let filled = 0;
        inputs.forEach(input => {
            if (input.value.trim() !== '') {
                filled++;
            }
        });
        const progress = (filled / inputs.length) * 100;
        progressBar.style.width = progress + '%';
        
        // Change color based on completion
        if (progress === 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (progress >= 50) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-primary';
        }
    }
    
    // Add event listeners for progress tracking
    inputs.forEach(input => {
        input.addEventListener('input', updateProgress);
        input.addEventListener('change', updateProgress);
    });
    
    // Initialize with current values
    updateProgress();
});
function calculateDebtBrake() {
    const revenue = parseFloat(document.getElementById('revenue').value);
    const expenses = parseFloat(document.getElementById('expenses').value);
    const existingDebt = parseFloat(document.getElementById('existingDebt').value);
    const debtServiceRatio = parseFloat(document.getElementById('debtServiceRatio').value);
    
    if (!revenue || !expenses || existingDebt === undefined) {
        showMobileError(document.getElementById('translations').dataset.pleaseFillInAllRequiredFields);
        return;
    }
    
    const netIncome = revenue - expenses;
    const maxDebtService = netIncome * debtServiceRatio;
    const maxNewDebt = (maxDebtService * 12) - existingDebt;
    const debtToIncomeRatio = existingDebt / netIncome;
    const isSustainable = debtToIncomeRatio <= debtServiceRatio;
    
    const results = {
        netIncome: netIncome,
        maxDebtService: maxDebtService,
        maxNewDebt: Math.max(0, maxNewDebt),
        debtToIncomeRatio: debtToIncomeRatio,
        isSustainable: isSustainable
    };
    
    displayDebtBrakeResults(results);
}

function displayDebtBrakeResults(results) {
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    
    if (!resultsDiv || !resultsContent) return;
    
    // Clear previous results
    resultsContent.innerHTML = '';
    
    // Create visual chart
    createDebtChart(results);
    
    // Create results cards
    const translations = document.getElementById('translations').dataset;
    const cards = [
        {
            title: translations.netIncome,
            value: results.netIncome,
            icon: 'fas fa-euro-sign',
            color: 'success'
        },
        {
            title: translations.maxMonthlyDebtService,
            value: results.maxDebtService,
            icon: 'fas fa-calculator',
            color: 'primary'
        },
        {
            title: translations.maxNewDebtCapacity,
            value: results.maxNewDebt,
            icon: 'fas fa-plus-circle',
            color: 'info'
        },
        {
            title: translations.currentDebtToIncomeRatio,
            value: (results.debtToIncomeRatio * 100).toFixed(1) + '%',
            icon: 'fas fa-percentage',
            color: results.isSustainable ? 'success' : 'warning'
        }
    ];
    
    cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'card mb-3';
        cardElement.innerHTML = `
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="${card.icon} text-${card.color} fs-4"></i>
                    </div>
                    <div>
                        <h6 class="card-title mb-1">${card.title}</h6>
                        <p class="card-text h5 text-${card.color} mb-0">${formatNumber(card.value)}</p>
                    </div>
                </div>
            </div>
        `;
        resultsContent.appendChild(cardElement);
    });
    
    // Add sustainability assessment
    const assessmentDiv = document.createElement('div');
    assessmentDiv.className = `alert alert-${results.isSustainable ? 'success' : 'warning'}`;
    assessmentDiv.innerHTML = `
        <i class="fas fa-${results.isSustainable ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        <strong>${results.isSustainable ? translations.sustainable : translations.warning}:</strong>
        ${results.isSustainable ? 
            translations.sustainableLimits : 
            translations.exceedsLimits
        }
    `;
    resultsContent.appendChild(assessmentDiv);
    
    // Show results with animation
    resultsDiv.style.display = 'block';
    resultsDiv.classList.add('animate-fade-in-up');
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function createDebtChart(results) {
    const ctx = document.getElementById('debtChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (window.debtChart) {
        window.debtChart.destroy();
    }
    
    const revenue = parseFloat(document.getElementById('revenue').value);
    const expenses = parseFloat(document.getElementById('expenses').value);
    const existingDebt = parseFloat(document.getElementById('existingDebt').value);
    
    window.debtChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Revenue', 'Expenses', 'Existing Debt', 'Available Capacity'],
            datasets: [{
                data: [
                    revenue,
                    expenses,
                    existingDebt,
                    Math.max(0, results.maxNewDebt)
                ],
                backgroundColor: [
                    '#28a745', // Revenue - green
                    '#dc3545', // Expenses - red
                    '#ffc107', // Existing Debt - yellow
                    '#17a2b8'  // Available Capacity - blue
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': €' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function resetForm() {
    document.getElementById('debtBrakeForm').reset();
    document.getElementById('results').style.display = 'none';
}

function exportToPDF() {
    // Simple PDF export using browser print
    window.print();
}

function exportToExcel() {
    const results = getCurrentResults();
    if (!results) {
        alert('Please calculate results first');
        return;
    }
    
    // Create CSV content
    const csvContent = [
        ['Debt Brake Calculator Results'],
        ['Date', new Date().toLocaleDateString()],
        [''],
        ['Input Data'],
        ['Annual Revenue', document.getElementById('revenue').value],
        ['Annual Expenses', document.getElementById('expenses').value],
        ['Existing Debt', document.getElementById('existingDebt').value],
        ['Debt Service Ratio', document.getElementById('debtServiceRatio').value],
        [''],
        ['Results'],
        ['Net Income', results.netIncome],
        ['Max Monthly Debt Service', results.maxDebtService],
        ['Max New Debt Capacity', results.maxNewDebt],
        ['Current Debt-to-Income Ratio', (results.debtToIncomeRatio * 100).toFixed(1) + '%'],
        ['Sustainable', results.isSustainable ? 'Yes' : 'No']
    ];
    
    // Convert to CSV string
    const csvString = csvContent.map(row => 
        row.map(cell => `"${cell}"`).join(',')
    ).join('\n');
    
    // Download CSV file
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'debt_brake_results.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function getCurrentResults() {
    const revenue = parseFloat(document.getElementById('revenue').value);
    const expenses = parseFloat(document.getElementById('expenses').value);
    const existingDebt = parseFloat(document.getElementById('existingDebt').value);
    const debtServiceRatio = parseFloat(document.getElementById('debtServiceRatio').value);
    
    if (!revenue || !expenses || existingDebt === undefined) {
        return null;
    }
    
    const netIncome = revenue - expenses;
    const maxDebtService = netIncome * debtServiceRatio;
    const maxNewDebt = Math.max(0, (maxDebtService * 12) - existingDebt);
    const debtToIncomeRatio = existingDebt / netIncome;
    const isSustainable = debtToIncomeRatio <= debtServiceRatio;
    
    return {
        netIncome: netIncome,
        maxDebtService: maxDebtService,
        maxNewDebt: maxNewDebt,
        debtToIncomeRatio: debtToIncomeRatio,
        isSustainable: isSustainable
    };
}
</script>
{% endblock %}
